--
title: "Introduction to slimmmingDive"
author: "Fer Arce"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


This is a minimal example to introduce the usage of **slimmingDive** with
southern elephant seals dive information kindly provided by the
Australian Integrated Marine Observing System (IMOS). It requires the external software JAGS (Just another Gibs
sampler) to be installed or slimmingDive will fail to install.

slimmingDive is not on cran, so you need to download and install it
locally. You can also use either `remotes` or `devtools` packages. If
you are reading this vignette, it means that you have installed
**slimmingDive** already :).

```{r }
remotes::install_github('farcego/slimmingDive')

```

Load the data:
```{r }
library(slimmingDive)

data(ele)
```

These type of datasets tipically contain a large number of columns,
innecesary to our purposes, so better to pre-process the data. This
step is important as it will rename and create few extra variables
needed for further steps. It also removes short, shallower dives.

```{r }
Data <- formatDives(ele)

dim(Data)
```

Next step is to otain the order in which the inflection points are
generated, as the Drifing segment and drift rate depends on them

```{r }

Data[c('order','minresid')] <- t(apply(Data,1,RBSM,retrieve='both'))
Data$minresid <- as.numeric(Data$minresid)
```
Now we can  generate a large bunch of variables for filtering purposes.

```{r }
D1 <- NewVarsVect(Data)
```
And get the Drift rate estimate and drifting segment:

```{r }
D1[c('NDE','ds')] <- t(apply(D1,1,NDE, extract='both'))
```




```{r }
plotDrift(D1, xlab = 'foraging days', ylab = 'Drift rate',
          xlim = c(-10, 245))

```
We have a bunch of dives with associated drift rates at any value

Next step would be to get ridden of those that are certainly no drift
dives:


```{r }
D1 <- driftFilter(D1)
## let's have a quick look
plotDrift(D1, xlab = 'foraging days', ylab = 'Drift rate', xlim = c(-10, 245))



```

A pattern aroses, but a last step is required to filter the
unrealistic values still retained by the filtering process. Because
it is time consuming, we can load the same seal processed. The data
cames in a complex format, but we can just get what we want easily:

```{r }

## D2 <- Kalman(D1,400000, 1000)
data(elek)
plotDrift(elek$Data, xlab = 'foraging days', ylab = 'Drift rate', xlim = c(-10, 245))

identical(elek$Data, D1)

dim(D1)
dim(elek$Data)

## ok, the problem is in the formats. I should move time to previous steps

for(i in 1:48){
    (identical(elek$Data[[1]], D1[[1]]), '\t')
}

identical(elek$Data[,1:48], D1)

names(elek$Data) %in% names(D1)
## collect data
D2 <- PostKalman(elek)
## select the Drift dives
D2 <- D2[D2$zetas > .99, ]

plotDrift(D2, xlab = 'foraging days', ylab = 'Drift rate', xlim = c(-10, 245))

```
